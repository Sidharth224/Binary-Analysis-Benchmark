#!/bin/bash
#This script automates the binary generation with given CVE, board and sample

#set -x
set -e

cd /home/sidharth/zephyr-2.4.0/zephyr

# Restore git state
git reset --hard
git clean -df
git checkout "$BASE_COMMIT"
west update

# Backport fix for device binding bug
git cherry-pick 5b36a01a67dd705248496ef46999f39b43e02da9 --no-commit

# Revert the changes that fixed the issue (but keep the other fixes)
for commit in $FIX_COMMITS; do
    git revert "$commit" -n
done

# Build sample
cd $SAMPLE_DIR
rm -rf build
for board in $BOARDS; do
    west build --pristine always -b "$board" 2>/dev/null

    if [ -f build/zephyr/zephyr.elf ]; then
        cp build/zephyr/zephyr.elf $OUT_DIR/CVE-$CVENUM-"$board".elf
        echo "===================> Sample $SAMPLE.elf for $board was created successfully <==================="; else
        echo "===================> Sample $SAMPLE.elf for $board was not created <==================="
    fi

    if [ -f build/zephyr/zephyr.bin ]; then  
        cp build/zephyr/zephyr.bin $OUT_DIR/CVE-$CVENUM-"$board".bin
        echo "===================> Sample $SAMPLE.bin for $board was created successfully <==================="; else
        echo "===================> Sample $SAMPLE.bin for $board was not created <===================" 
    fi

    rm -rf build
done 
