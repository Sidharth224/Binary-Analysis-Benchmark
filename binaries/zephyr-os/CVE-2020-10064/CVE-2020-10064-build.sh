#!/bin/bash
#This script automates the binary generation with given CVE, BOARD and sample

set -x
set -e

cd $ZEPHYR_BASE_DIR

# Restore git state
git reset --hard
git clean -df
git checkout "$BASE_COMMIT"
west update

# Backport fix for device binding bug
git cherry-pick 5b36a01a67dd705248496ef46999f39b43e02da9 --no-commit

# Revert the changes that fixed the issue (but keep the other fixes)
for commit in $FIX_COMMITS; do
    git revert "$commit" -n
done

# Build sample
for SAMPLE in $SAMPLE_DIR; do
    cd $SAMPLE
    rm -rf build

    SAMPLE_NAME="$(basename -- $SAMPLE)"
    SAMPLE_CLASS=$(echo "$SAMPLE" | cut -d / -f 7)

    if [ -d $OUT_DIR/$SAMPLE_CLASS-$SAMPLE_NAME ]; then
        rm -rf $OUT_DIR/$SAMPLE_CLASS-$SAMPLE_NAME;
    fi

    mkdir $OUT_DIR/$SAMPLE_CLASS-$SAMPLE_NAME

    for BOARD in $BOARDS; do
        west build --pristine always -b "$BOARD" 
        # 2>/dev/null

        if [ -f build/zephyr/zephyr.elf ]; then
            cp build/zephyr/zephyr.elf $OUT_DIR/$SAMPLE_CLASS-$SAMPLE_NAME/CVE-$CVENUM-"$BOARD".elf
            echo "===================> Sample $SAMPLE_NAME.elf for $BOARD was created successfully <==================="; else
            echo "===================> Sample $SAMPLE_NAME.elf for $BOARD was not created <==================="
        fi

        if [ -f build/zephyr/zephyr.bin ]; then  
            cp build/zephyr/zephyr.bin $OUT_DIR/$SAMPLE_CLASS-$SAMPLE_NAME/CVE-$CVENUM-"$BOARD".bin
            echo "===================> Sample $SAMPLE_NAME.bin for $BOARD was created successfully <==================="; else
            echo "===================> Sample $SAMPLE_NAME.bin for $BOARD was not created <===================" 
        fi

        rm -rf build
    done   
done

